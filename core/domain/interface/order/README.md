# 退款 #

如果全部退款，订单状态已关闭。 如果是部分退款，订单不变。标记为退款


# 订单全流程：从父订单到仓库出库单

参考:https://www.jianshu.com/p/8c30b7503f48

正常购物的流程：选购好商品从购物车下单、生成订单、确认订单支付、然后坐等收货、收到货确认收货。

从购物车里面会选多个商家的商品一起下单，有时每个商家一个包裹，也有一个商家多个包裹的情况，这是怎么实现的呢？

在这个过程中有父订单、子订单、发货单、仓库出库单等各种单据，还存在拆单。对于非自营的平台，如淘宝来说，只有第1次拆单；对自营的平台来说，有第1次和第2次拆单；对各种平台的商家来说，只有第2次拆单。

一、第一次拆单

从购物车下单的时候，顾客会同时选择多个商家的商品一起下单，这时候可以一起支付。但是支付完成后，跟踪订单，一般一个店铺一张订单，可以在“我的订单”中看到，这里就要说到父订单和子订单。

顾客从购物车选中多件商品下单的时候，会生成一个父订单和多个子订单。一般子订单拆分的规则是按照店铺，每个店铺一张子订单，如果其中有店铺是自营的，可能会将该店铺的商品按照发货仓库提前拆分成多个子订单。

子订单是后续追踪发货物流、售后以及财务结算的依据。包括订单明细、商品明细、支付明细、收货信息、发票信息、服务信息、物流信息、发货信息等各种内容。

父订单有什么作用呢？除了记录用户这一次下多单的行为，还有合并支付。如果有跨商家优惠，父订单可以对应到相应的优惠，然后对各个商家进行摊分。一般在用户下完单之后，父订单的作用基本上是已经完成了。在订单产品架构的设计中，并不是需要拆单的订单才有父订单，而是所有的订单都需要生成父子订单。

在销售层生成子订单之后，接下来就要处理订单发货的问题。自营平台会把订单推送到自己的调度中心进行处理，平台的商家有几种处理方式，一是通过手工的方式将订单导出，然后安排发货，发完货再回到平台的店铺管理里进行更新发货信息；二是通过系统对接的方式将销售订单下载至自己的订单处理中心或ERP里，安排发货。

二、第二次拆单

销售层推送订单至调度层，也是订单系统向调度中心推送的过程。调度中心收到销售订单后，首先是根据相应的规则进行审核，如风控规则识别的风险订单进行拦截，信息不完整的订单需要人工介入，收到销售订单后，一段时间后再进行审核，比如半小时等等。

审核通过的订单开始配货，配货的时候，就是拆单规则发挥作用的时候。首先需要明确一个原则，有库存的商品才允许配货。这一层拆的是发货单，不是子订单，拆再多用户看到的还是一个子订单。但是子订单对应多个包裹，也就是多个物流单号。

拆单规则

1.仓库：按照区域调度的原则为订单商品选择发货仓库，不同的仓库需要生成不同的发货单；

2.重量/体积：在选择仓库之后，因为仓库包装的重量或者体积的限制，需要进行拆单；

3.品类：由于易燃或者贵重物品，需要单独打包，也是要进行拆单，在跨境电商中还存在包括价值限额的问题；

4.库存：没有库存的商品是不会下发到仓库的，审完发货单之后可以等发货单中的全部商品有货在下推仓库，也可以确定有货先配的原则，这时也需要拆单。

经过以上的原则，一个子订单可能拆成多个发货单，也可能一个子订单还是对应一个发货单；经过这一层拆单，最好的状态是发货单下发至仓库，仓库就可以打包成一个包裹进行出库。在发货单生成之后，就需要安排发货单进行出库，也就是推送至wms系统中。

一般情况下，仓库收到发货单之后，按照整单进行出库。只有在调度中心做的不够好的情况下，仓库才需要打包成多个包裹。

三、取消订单

在订单支付后发货前，会有用户申请取消订单的情况，这时候需要系统去拦截订单的发货流程，如果拦截不成功，顾客就只有退货了，退货的成本肯定是比取消订单的成本要高很多。

这时候有三个节点去拦截订单：

1. 销售层

在用户下单后，销售订单还没有下发至调度层，可以直接拦截成功；如果在销售层没有拦截成功，就需要去调度层进行拦截。

2. 调度层

我们前面说到，订单稍发到调度层，需要经过审核以及配货。如果订单未审核就直接取消，成功后返回调度层，取消相应的订单；审核后配货成功前需要去取消发货单，这时也算拦截成功；如果配货成功，已经下发至仓库，这需要再去仓库wms系统进行拦截。

3. 仓库层

调度中心和仓库进行对接后，通过接口取消仓库出库单，如果wms拦截出库单成功，则拦截成功。如果到这个节点，拦截不成功，就是取消订单失败。

一般WMS系统都支持在仓库出库之前都可以拦截成功，但是如果调度中心没有实现和wms系统的完整对接，就无法实现这个功能。

经过以上三个节点，如果拦截成功，那订单就可以允许取消，发起退款。如果拦截不成功，就只有等用户收到货之后进行退货。

四、几个单据

在整个流程之中，有父订单、子订单、发货单、仓库出库单等几种类型的单据，千万不要搞混，每个单据在不同的环节发挥着不同的作用。

为什么要做这么复杂？我们希望送到用户手中的每一个包裹在系统中都有详细的数据记录，而不会因为有些数据空白而产生纠纷。


## 支付订单
https://www.woshipm.com/pd/2972697.html


用户把订单提交后此时后台会有两步操作：

1）拆单

多商家情况下，提交订单就进行拆单，拆后流转至对应的商家后台，用户也会看到多个子订单；其他还可以按发货仓库等维度拆；

2）生成账单

生成账单的目的是为了记录该笔母订单的金额，如商品金额、抵扣总金额、各商品分别抵扣金额、用户需支付金额等，用户将要支付的是母订单的账单，当该笔账单已完成，则各子订单状态跳转为待发货；

注意，如果用户在支付页面退出，此时账单也会随着商家拆分成各子账单，因为用户可以在订单列表里分别对拆分后的子订单进行支付
